# –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Core Service

## –ü—Ä–æ–±–ª–µ–º–∞

–§–∞–π–ª `admin_app.py` —Å—Ç–∞–ª **—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–º** (1425 —Å—Ç—Ä–æ–∫) –∏ **–ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω—ã–º**:
- –°–º–µ—à–∏–≤–∞–µ—Ç HTTP —É—Ç–∏–ª–∏—Ç—ã, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, —Ä–æ—É—Ç—ã, HTML
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (JWT signing –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è 3+ —Ä–∞–∑–∞)
- –°–ª–æ–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ —Ä–∞—Å—à–∏—Ä—è—Ç—å
- –¢—è–∂–µ–ª–æ –ø–æ–Ω—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É

## –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
core-service/
‚îú‚îÄ‚îÄ utils/              # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ http_client.py  # HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è Client Manager
‚îÇ   ‚îî‚îÄ‚îÄ auth.py         # JWT –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îú‚îÄ‚îÄ routes/             # API —Ä–æ—É—Ç—ã (–ø–æ–∫–∞ –ø—É—Å—Ç–æ, ready for extraction)
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ static/             # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã (HTML, JS, CSS)
‚îú‚îÄ‚îÄ app.py              # ‚ú® –ù–û–í–´–ô —á–∏—Å—Ç—ã–π app factory
‚îî‚îÄ‚îÄ admin_app.py        # –°—Ç–∞—Ä—ã–π —Ñ–∞–π–ª (TODO: —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏)
```

### ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω—ã –º–æ–¥—É–ª–∏

1. **`utils/http_client.py`** - HTTP —É—Ç–∏–ª–∏—Ç—ã
   - `_http_json()` - JSON –∑–∞–ø—Ä–æ—Å—ã –∫ client-manager
   - `_http_multipart()` - Multipart file uploads
   - `_http_multipart_stream()` - Streaming uploads

2. **`utils/auth.py`** - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
   - `generate_jwt_token()` - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT (HS256/RS256)
   - `get_admin_headers()` - Headers –¥–ª—è admin API
   - `require_admin_auth()` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è auth

3. **`app.py`** - –ù–æ–≤—ã–π —á–∏—Å—Ç—ã–π application factory
   - –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
   - –ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é —Ä–æ—É—Ç–æ–≤
   - –ß–∏—Å—Ç—ã–π lifecycle management
   - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

1. **–ù–∞—á–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –∫–æ–¥–µ**
   ```python
   # –í–º–µ—Å—Ç–æ:
   data = await asyncio.to_thread(_http_json, "GET", "/api/clients")
   
   # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
   from utils.http_client import _http_json
   data = await asyncio.to_thread(_http_json, "GET", "/api/clients")
   ```

2. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –∏–∑–≤–ª–µ–∫–∞—Ç—å —Ä–æ—É—Ç—ã** –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã:
   - `routes/clients.py` - /api/clients/*
   - `routes/plugins.py` - /api/plugins/*, /api/registry/*
   - `routes/files.py` - /api/files/*
   - `routes/enrollments.py` - /api/enrollments/*
   
3. **–ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–æ—É—Ç—ã –≤ app.py**
   ```python
   from .routes import clients, plugins, files, enrollments
   app.include_router(clients.router, prefix="/api")
   app.include_router(plugins.router, prefix="/api")
   ```

4. **–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –Ω–æ–≤—ã–π app.py**
   - –û–±–Ω–æ–≤–∏—Ç—å `main.py`: `from .app import create_admin_app`
   - –û–±–Ω–æ–≤–∏—Ç—å `asgi.py`: `from .app import create_admin_app`
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
   - –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π `admin_app.py`

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å (–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

–ï—Å–ª–∏ –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥:
- –•–æ—Ç—è –±—ã –Ω–∞—á–Ω–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `utils/http_client.py` –∏ `utils/auth.py`
- –≠—Ç–æ —É–º–µ–Ω—å—à–∏—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- –£–ø—Ä–æ—Å—Ç–∏—Ç maintenance

## –ü–æ–ª—å–∑–∞ –æ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### –°–µ–π—á–∞—Å: üò´
- 1425 —Å—Ç—Ä–æ–∫ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ
- –°–ª–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π endpoint
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ JWT –∫–æ–¥–∞
- –°–º–µ—à–∞–Ω–∞ —Ä–∞–∑–Ω–∞—è –ª–æ–≥–∏–∫–∞

### –ü–æ—Å–ª–µ: üòä
- –ß–∏—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ –¥–æ–º–µ–Ω–∞–º
- –õ–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π –∫–æ–¥
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —É—Ç–∏–ª–∏—Ç—ã
- –ü—Ä–æ—Å—Ç–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ endpoint'—ã

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ admin_app.py

–î–∞, `admin_app.py` **–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**:
- ‚úÖ `main.py` - –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `create_admin_app()`
- ‚úÖ `asgi.py` - –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç `create_admin_app()`
- ‚úÖ README.md - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É
- ‚úÖ Docker - –≤ production

–ü–æ—ç—Ç–æ–º—É —É–¥–∞–ª—è—Ç—å –µ–≥–æ –ù–ï–õ–¨–ó–Ø –¥–æ –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É.

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:
1. ‚úÖ –ù–∞—á–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `utils/http_client.py` –¥–ª—è –Ω–æ–≤—ã—Ö endpoint'–æ–≤
2. ‚úÖ –ù–∞—á–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `utils/auth.py` –¥–ª—è JWT –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

### –í —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏:
3. üìã –°–æ–∑–¥–∞—Ç—å `routes/clients.py` –∏ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ç—É–¥–∞ –≤—Å–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ endpoint'—ã
4. üìã –°–æ–∑–¥–∞—Ç—å `routes/plugins.py` –¥–ª—è plugin/registry endpoint'–æ–≤

### –í —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞:
5. üìã –ó–∞–≤–µ—Ä—à–∏—Ç—å extraction –≤—Å–µ—Ö —Ä–æ—É—Ç–æ–≤
6. üìã –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ `app.py`
7. üìã –£–¥–∞–ª–∏—Ç—å `admin_app.py`
8. üéâ Profit!

## –í–æ–ø—Ä–æ—Å—ã?

- **Q: –ü–æ—á–µ–º—É –Ω–µ —É–¥–∞–ª–∏–ª–∏ admin_app.py?**
  A: –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ production. –£–¥–∞–ª–∏–º –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏.

- **Q: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å?**
  A: –ù–µ—Ç, –Ω–æ –æ—á–µ–Ω—å –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ. –ß–µ–º –±–æ–ª—å—à–µ —Ä–∞—Å—Ç–µ—Ç –∫–æ–¥, —Ç–µ–º —Å–ª–æ–∂–Ω–µ–µ –±—É–¥–µ—Ç –ø–æ—Ç–æ–º.

- **Q: –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–π–º–µ—Ç?**
  A: 2-4 —á–∞—Å–∞ –Ω–∞ –ø–æ–ª–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.

- **Q: –ú–æ–∂–Ω–æ –ª–∏ –¥–µ–ª–∞—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ?**
  A: –î–∞! –ò–º–µ–Ω–Ω–æ —Ç–∞–∫ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è. –ü–æ –æ–¥–Ω–æ–º—É —Ä–æ—É—Ç—É –∑–∞ —Ä–∞–∑.
