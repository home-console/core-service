# üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —è–¥—Ä–∞ (Core Service)

## ‚ö†Ô∏è –ú–∞—Å—à—Ç–∞–±–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

---

## 1. üî¥ Service Locator –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω (–ö–†–ò–¢–ò–ß–ù–û)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `app.state.plugin_loader`, `app.state.event_bus` - —ç—Ç–æ Service Locator –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω.

**–ì–¥–µ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è:**
- `routes/plugins.py`: 50+ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π `app.state.plugin_loader`
- `routes/devices.py`: –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ `app.state`
- –í—Å–µ –ø–ª–∞–≥–∏–Ω—ã –ø–æ–ª—É—á–∞—é—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ `app.state`

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:**
- ‚ùå –°–∏–ª—å–Ω–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å - –∫–æ–¥ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã `app.state`
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
- ‚ùå –°–∫—Ä—ã—Ç—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ - –Ω–µ –≤–∏–¥–Ω–æ —á—Ç–æ –Ω—É–∂–Ω–æ
- ‚ùå –°–ª–æ–∂–Ω–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã:**
```python
# routes/plugins.py - –≤–µ–∑–¥–µ —Ç–∞–∫:
if hasattr(app.state, 'plugin_loader'):
    plugin_loader = app.state.plugin_loader
    # ... –∫–æ–¥ ...
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å FastAPI Depends –¥–ª—è dependency injection
from fastapi import Depends

def get_plugin_loader(request: Request) -> PluginLoader:
    """Dependency –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è plugin_loader"""
    if not hasattr(request.app.state, 'plugin_loader'):
        raise HTTPException(500, "Plugin loader not available")
    return request.app.state.plugin_loader

@router.get("/plugins")
async def list_plugins(
    plugin_loader: PluginLoader = Depends(get_plugin_loader)
):
    # –¢–µ–ø–µ—Ä—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —è–≤–Ω–∞—è –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–∞—è
    return plugin_loader.list_plugins()
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ù–û - –≤–ª–∏—è–µ—Ç –Ω–∞ –≤—Å—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

---

## 2. üî¥ –ì–ª–æ–±–∞–ª—å–Ω—ã–π singleton event_bus (–ö–†–ò–¢–ò–ß–ù–û)

**–ü—Ä–æ–±–ª–µ–º–∞:** `event_bus` —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–∞–∫ –≥–ª–æ–±–∞–ª—å–Ω—ã–π singleton –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è.

**–ì–¥–µ:**
```python
# event_bus.py:284
event_bus = EventBus()  # –ì–ª–æ–±–∞–ª—å–Ω—ã–π singleton
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:**
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
- ‚ùå –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–∑–¥–µ–ª—è–µ—Ç—Å—è –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
- ‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º –∑–∞–ø—É—Å–∫–æ–º —Ç–µ—Å—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –°–æ–∑–¥–∞–≤–∞—Ç—å event_bus –≤ lifespan, –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —á–µ—Ä–µ–∑ DI
@asynccontextmanager
async def lifespan(app: FastAPI):
    event_bus = EventBus()  # –°–æ–∑–¥–∞–µ–º –∑–¥–µ—Å—å
    app.state.event_bus = event_bus
    yield
    # Cleanup

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Depends
def get_event_bus(request: Request) -> EventBus:
    return request.app.state.event_bus
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ù–û - –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## 3. üî¥ 32 print() –≤–º–µ—Å—Ç–æ logging (–í–´–°–û–ö–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `app.py` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 32+ `print()` –≤–º–µ—Å—Ç–æ `logging`.

**–ì–¥–µ:**
```python
# app.py - –≤–µ–∑–¥–µ —Ç–∞–∫:
print("üîµ app.py: Log levels set")
print("‚úÖ app.py: FastAPI imported")
print(f"‚ùå Failed to load internal plugins: {e}")
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:**
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏
- ‚ùå –ù–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- ‚ùå –ü–ª–æ—Ö–æ –¥–ª—è production

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ print() –Ω–∞ logger
logger = logging.getLogger(__name__)

# –ë—ã–ª–æ:
print("‚úÖ FastAPI imported")

# –°—Ç–∞–ª–æ:
logger.info("FastAPI imported")
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í–´–°–û–ö–ò–ô - –≤–ª–∏—è–µ—Ç –Ω–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫—É

---

## 4. üî¥ –ú–Ω–æ–∂–µ—Å—Ç–≤–æ bare `except Exception:` (–í–´–°–û–ö–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:** 100+ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π `except Exception:` –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ —Å `pass`.

**–ì–¥–µ:**
```python
# app.py shutdown - —Å–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –æ—à–∏–±–∫–∏:
try:
    if _health_monitor is not None:
        await _health_monitor.stop()
except Exception:  # ‚ùå –°–∫—Ä—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏!
    pass

# routes/plugins.py - –≤–µ–∑–¥–µ —Ç–∞–∫:
except Exception:
    pass  # ‚ùå –¢–µ—Ä—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–∞—Ö
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:**
- ‚ùå –°–∫—Ä—ã–≤–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ª–∞–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
- ‚ùå –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —É—Ç–µ—á–∫–∞–º —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚ùå –ü–ª–∞–≥–∏–Ω—ã –º–æ–≥—É—Ç –Ω–µ –æ—á–∏—Å—Ç–∏—Ç—å—Å—è –ø—Ä–∏ shutdown

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –í—Å–µ–≥–¥–∞ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–µ—Ä–µ–±—Ä–∞—Å—ã–≤–∞—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
try:
    await _health_monitor.stop()
except Exception as e:
    logger.error(f"Failed to stop health monitor: {e}", exc_info=True)
    # –î–ª—è shutdown - –º–æ–∂–Ω–æ –Ω–µ –ø–µ—Ä–µ–±—Ä–∞—Å—ã–≤–∞—Ç—å, –Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í–´–°–û–ö–ò–ô - —Å–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã

---

## 5. üî¥ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–≥–∏–Ω–æ–≤ (–í–´–°–û–ö–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–ª–∞–≥–∏–Ω—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤ —Ü–∏–∫–ª–µ.

**–ì–¥–µ:**
```python
# plugin_system/loader.py:101
for module_name, is_package in plugin_modules:
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ –æ–¥–Ω–æ–º—É
    await self.load_plugin(module_name, plugin_type="builtin")
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:**
- ‚ùå –ú–µ–¥–ª–µ–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (10 –ø–ª–∞–≥–∏–Ω–æ–≤ √ó 2 —Å–µ–∫ = 20 —Å–µ–∫)
- ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
- ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º concurrency
async def _load_builtin_plugins(self):
    plugin_modules = PluginFinder.find_builtin_plugins()
    
    semaphore = asyncio.Semaphore(5)  # –ú–∞–∫—Å–∏–º—É–º 5 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
    
    async def load_with_semaphore(module_name, is_package):
        async with semaphore:
            return await self._load_single_plugin(module_name, is_package)
    
    tasks = [
        load_with_semaphore(module_name, is_package)
        for module_name, is_package in plugin_modules
    ]
    
    results = await asyncio.gather(*tasks, return_exceptions=True)
    # –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í–´–°–û–ö–ò–ô - –≤–ª–∏—è–µ—Ç –Ω–∞ –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞

---

## 6. üî¥ –ù–µ—Ç –∏–∑–æ–ª—è—Ü–∏–∏ –æ—à–∏–±–æ–∫ –ø–ª–∞–≥–∏–Ω–æ–≤ (–í–´–°–û–ö–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –æ–¥–∏–Ω –ø–ª–∞–≥–∏–Ω –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å –≤–µ—Å—å loader.

**–ì–¥–µ:**
```python
# plugin_system/loader.py:142
except Exception as e:
    logger.error(f"‚ùå Failed to load plugin package {module_name}: {e}", exc_info=True)
    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º, –Ω–æ –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞—è - –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å –≤—Å–µ
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:**
- ‚ùå –û–¥–∏–Ω –ø–ª–æ—Ö–æ–π –ø–ª–∞–≥–∏–Ω –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å –≤—Å—é —Å–∏—Å—Ç–µ–º—É
- ‚ùå –ù–µ—Ç graceful degradation
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ –ø–ª–∞–≥–∏–Ω–∞–º–∏

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ò–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π –ø–ª–∞–≥–∏–Ω –≤ try-except
async def _load_single_plugin(self, module_name, is_package):
    try:
        # –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–≥–∏–Ω–∞
        plugin = await self._load_plugin_internal(module_name, is_package)
        return {"status": "loaded", "plugin": plugin}
    except ImportError as e:
        logger.warning(f"Plugin {module_name} import failed: {e}")
        return {"status": "failed", "error": "import_error", "details": str(e)}
    except Exception as e:
        logger.error(f"Plugin {module_name} load failed: {e}", exc_info=True)
        return {"status": "failed", "error": "unknown", "details": str(e)}
    # –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∞–¥–∞–µ–º
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í–´–°–û–ö–ò–ô - –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å

---

## 7. üü† –ù–µ—Ç graceful shutdown (–°–†–ï–î–ù–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ shutdown –ø–ª–∞–≥–∏–Ω—ã –º–æ–≥—É—Ç –Ω–µ —É—Å–ø–µ—Ç—å –æ—á–∏—Å—Ç–∏—Ç—å—Å—è.

**–ì–¥–µ:**
```python
# app.py:474-524
yield  # Shutdown –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–¥–µ—Å—å

# –ú–Ω–æ–∂–µ—Å—Ç–≤–æ bare except - –º–æ–≥—É—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å cleanup
try:
    await _health_monitor.stop()
except Exception:
    pass  # ‚ùå –ú–æ–∂–µ—Ç –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:**
- ‚ùå –£—Ç–µ—á–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ (—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –ø–æ—Ç–æ–∫–∏, —Ñ–∞–π–ª—ã)
- ‚ùå –ü–ª–∞–≥–∏–Ω—ã –º–æ–≥—É—Ç –æ—Å—Ç–∞—Ç—å—Å—è –≤ –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- ‚ùå –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ

**–†–µ—à–µ–Ω–∏–µ:**
```python
# Graceful shutdown —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏
async def shutdown_plugins(plugin_loader: PluginLoader, timeout: float = 10.0):
    """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø–ª–∞–≥–∏–Ω—ã —Å —Ç–∞–π–º–∞—É—Ç–æ–º"""
    tasks = []
    for plugin_id, plugin in plugin_loader.plugins.items():
        async def unload_with_timeout(pid, p):
            try:
                await asyncio.wait_for(p.on_unload(), timeout=timeout)
            except asyncio.TimeoutError:
                logger.warning(f"Plugin {pid} unload timeout")
            except Exception as e:
                logger.error(f"Plugin {pid} unload error: {e}", exc_info=True)
        
        tasks.append(unload_with_timeout(plugin_id, plugin))
    
    await asyncio.gather(*tasks, return_exceptions=True)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô - –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤

---

## 8. üü† –°–º–µ—à–µ–Ω–∏–µ sync/async –∫–æ–¥–∞ (–°–†–ï–î–ù–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í async –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.

**–ì–¥–µ:**
```python
# plugin_system/loader.py:119
deps_result = await asyncio.to_thread(
    PluginDependencyInstaller.install_dependencies,
    plugin_path,
    plugin_dir_name
)
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è to_thread, –Ω–æ —ç—Ç–æ –Ω–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:**
- ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ—Ç event loop
- ‚ùå –ü–ª–æ—Ö–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚ùå –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ deadlock

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å async –≤–µ—Ä—Å–∏–∏ –∏–ª–∏ –≤—ã–Ω–æ—Å–∏—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
# –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å subprocess –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
async def install_dependencies_async(plugin_path: str, plugin_id: str):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"""
    process = await asyncio.create_subprocess_exec(
        sys.executable, "-m", "pip", "install", "-r", "requirements.txt",
        cwd=plugin_path,
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.PIPE
    )
    await process.communicate()
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô - –≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

---

## 9. üü† –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–ª–∞–≥–∏–Ω–æ–≤ (–°–†–ï–î–ù–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–æ–≤ –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º.

**–ì–¥–µ:**
```python
# plugin_system/loader.py:452
# –ü—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥ –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
plugin.config = merged
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:**
- ‚ùå Runtime –æ—à–∏–±–∫–∏ –≤–º–µ—Å—Ç–æ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- ‚ùå –°–ª–æ–∂–Ω–æ –æ—Ç–ª–∞–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
- ‚ùå –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Pydantic –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
from pydantic import BaseModel, ValidationError

class PluginConfigSchema(BaseModel):
    device_online_timeout: int = 300
    device_poll_interval: int = 60
    # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è

async def _apply_plugin_config(self, plugin):
    try:
        validated_config = PluginConfigSchema(**merged)
        plugin.config = validated_config.dict()
    except ValidationError as e:
        logger.error(f"Invalid config for {plugin.id}: {e}")
        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å defaults
        plugin.config = PluginConfigSchema().dict()
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô - –≤–ª–∏—è–µ—Ç –Ω–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å

---

## 10. üü° –ù–µ—Ç dependency injection –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–°–†–ï–î–ù–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã –∏–ª–∏ `app.state`.

**–ì–¥–µ:**
```python
# –ü–ª–∞–≥–∏–Ω—ã –ø–æ–ª—É—á–∞—é—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
plugin = plugin_class(self.app, self.db_session_maker, self.event_bus, models=models_dict)
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:**
- ‚ùå –°–ª–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- ‚ùå –°–ª–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚ùå –°–ª–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, dependency-injector)
from dependency_injector import containers, providers

class ApplicationContainer(containers.DeclarativeContainer):
    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    config = providers.Configuration()
    
    # –ë–î
    db_session_maker = providers.Singleton(AsyncSessionLocal)
    
    # Event Bus
    event_bus = providers.Singleton(EventBus)
    
    # Plugin Loader
    plugin_loader = providers.Factory(
        PluginLoader,
        db_session_maker=db_session_maker,
        event_bus=event_bus
    )

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
container = ApplicationContainer()
plugin_loader = container.plugin_loader()
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô - —É–ª—É—á—à–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

---

## 11. üü° –ù–µ—Ç –∏–∑–æ–ª—è—Ü–∏–∏ –ø–ª–∞–≥–∏–Ω–æ–≤ (–°–†–ï–î–ù–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–ª–∞–≥–∏–Ω—ã –º–æ–≥—É—Ç –≤–ª–∏—è—Ç—å –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞ —á–µ—Ä–µ–∑ –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

**–ì–¥–µ:**
- –í—Å–µ –ø–ª–∞–≥–∏–Ω—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω `event_bus`
- –í—Å–µ –ø–ª–∞–≥–∏–Ω—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω `db_session_maker`
- –ù–µ—Ç sandbox –¥–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:**
- ‚ùå –ü–ª–∞–≥–∏–Ω –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–ª–∞–≥–∏–Ω
- ‚ùå –ù–µ—Ç –∏–∑–æ–ª—è—Ü–∏–∏ –æ—à–∏–±–æ–∫
- ‚ùå –°–ª–æ–∂–Ω–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ò–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ë–î –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞–≥–∏–Ω–∞
class PluginSandbox:
    """–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞"""
    def __init__(self, plugin_id: str):
        self.plugin_id = plugin_id
        self.event_bus = EventBus()  # –°–≤–æ–π event bus
        self.db_session_maker = create_plugin_session_maker(plugin_id)
        self.logger = logging.getLogger(f"plugin.{plugin_id}")
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô - —É–ª—É—á—à–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å

---

## 12. üü° –ù–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–ù–ò–ó–ö–ò–ô)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≥—Ä—É–∑–∫–∏, –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ endpoints.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# Middleware –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
@app.middleware("http")
async def performance_middleware(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)
    duration = time.time() - start_time
    
    # –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    if duration > 1.0:
        logger.warning(f"Slow request: {request.url.path} took {duration:.2f}s")
    
    response.headers["X-Process-Time"] = str(duration)
    return response
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–ò–ó–ö–ò–ô - –ø–æ–ª–µ–∑–Ω–æ, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ

---

## üìä –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### üî¥ –ö–†–ò–¢–ò–ß–ù–û (—Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–º):
1. **Service Locator ‚Üí Dependency Injection** - –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –≤—Å–µ `app.state` –Ω–∞ `Depends`
2. **–ì–ª–æ–±–∞–ª—å–Ω—ã–π singleton ‚Üí DI** - —É–±—Ä–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π `event_bus`
3. **print() ‚Üí logging** - –∑–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ print –Ω–∞ logger

### üü† –í–´–°–û–ö–ò–ô (—Å–¥–µ–ª–∞—Ç—å –≤—Ç–æ—Ä—ã–º):
4. **Bare except ‚Üí –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ—à–∏–±–∫–∏
5. **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ ‚Üí –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è** - —É—Å–∫–æ—Ä–∏—Ç—å —Å—Ç–∞—Ä—Ç
6. **–ò–∑–æ–ª—è—Ü–∏—è –æ—à–∏–±–æ–∫ –ø–ª–∞–≥–∏–Ω–æ–≤** - graceful degradation

### üü° –°–†–ï–î–ù–ò–ô (—Å–¥–µ–ª–∞—Ç—å —Ç—Ä–µ—Ç—å–∏–º):
7. **Graceful shutdown** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
8. **Sync/async —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ** - —É–±—Ä–∞—Ç—å –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
9. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏** - Pydantic —Å—Ö–µ–º—ã
10. **DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä** - —É–ª—É—á—à–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

---

## üéØ –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (1-2 –Ω–µ–¥–µ–ª–∏)
1. –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `app.state` –Ω–∞ `Depends`
2. –£–±—Ä–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π `event_bus`
3. –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `print()` –Ω–∞ `logger`

### –§–∞–∑–∞ 2: –í—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ (1 –Ω–µ–¥–µ–ª—è)
4. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
5. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–≥–∏–Ω–æ–≤
6. –ò–∑–æ–ª—è—Ü–∏—è –æ—à–∏–±–æ–∫ –ø–ª–∞–≥–∏–Ω–æ–≤

### –§–∞–∑–∞ 3: –°—Ä–µ–¥–Ω–∏–µ (–ø–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
7-10. –û—Å—Ç–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

---

## üìù –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ –í—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞ < 5 —Å–µ–∫—É–Ω–¥ (—Å–µ–π—á–∞—Å –º–æ–∂–µ—Ç –±—ã—Ç—å 20+)
- ‚úÖ –¢–µ—Å—Ç—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –∏ –±—ã—Å—Ç—Ä—ã–µ
- ‚úÖ –û–¥–∏–Ω –ø–ª–∞–≥–∏–Ω –Ω–µ –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å —Å–∏—Å—Ç–µ–º—É
- ‚úÖ –í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- ‚úÖ Graceful shutdown —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `OPTIMIZATIONS.md` - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- `DEVELOPER_EXPERIENCE.md` - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

