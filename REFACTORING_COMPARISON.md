# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –î–æ –∏ –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### ‚ùå –î–û (–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
```
core-service/
‚îú‚îÄ‚îÄ admin_app.py          # üò± 1425 —Å—Ç—Ä–æ–∫!
‚îÇ   ‚îú‚îÄ‚îÄ HTTP —É—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ JWT –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ SQLAdmin setup
‚îÇ   ‚îú‚îÄ‚îÄ Lifecycle management
‚îÇ   ‚îú‚îÄ‚îÄ 50+ endpoint handlers
‚îÇ   ‚îú‚îÄ‚îÄ HTML —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
‚îÇ   ‚îî‚îÄ‚îÄ External plugin registration
‚îú‚îÄ‚îÄ main.py               # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –∏–∑ admin_app
‚îî‚îÄ‚îÄ asgi.py               # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –∏–∑ admin_app
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- üò´ –ù–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π –∫–æ–¥ = –ø–æ–∏—Å–∫ –≤ 1425 —Å—Ç—Ä–æ–∫–∞—Ö
- üò´ JWT –∫–æ–¥ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è 3+ —Ä–∞–∑–∞
- üò´ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π endpoint = –∏—Å–∫–∞—Ç—å –∫—É–¥–∞ –≤—Å—Ç–∞–≤–∏—Ç—å
- üò´ –¢—è–∂–µ–ª–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- üò´ –°–ª–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å —á—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–¥

### ‚úÖ –ü–û–°–õ–ï (–ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
```
core-service/
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ http_client.py    # HTTP —É—Ç–∏–ª–∏—Ç—ã (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ)
‚îÇ   ‚îî‚îÄ‚îÄ auth.py           # JWT –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–æ–¥–Ω–æ –º–µ—Å—Ç–æ)
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ clients.py        # Endpoint'—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ plugins.py        # Endpoint'—ã –¥–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ files.py          # Endpoint'—ã –¥–ª—è —Ñ–∞–π–ª–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ enrollments.py    # Endpoint'—ã –¥–ª—è enrollments
‚îú‚îÄ‚îÄ static/
‚îÇ   ‚îî‚îÄ‚îÄ admin.html        # HTML —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (–æ—Ç–¥–µ–ª—å–Ω–æ)
‚îú‚îÄ‚îÄ app.py                # ‚ú® –ß–∏—Å—Ç—ã–π application factory
‚îú‚îÄ‚îÄ admin_app.py          # (–æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
‚îú‚îÄ‚îÄ main.py               # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –∏–∑ app
‚îî‚îÄ‚îÄ asgi.py               # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –∏–∑ app
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–∞–π—Ç–∏ –∫–æ–¥ = –∑–Ω–∞–µ—à—å –≤ –∫–∞–∫–æ–π —Ñ–∞–π–ª —Å–º–æ—Ç—Ä–µ—Ç—å
- ‚úÖ JWT –∫–æ–¥ = –æ–¥–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è, –æ–¥–Ω–æ –º–µ—Å—Ç–æ
- ‚úÖ –ù–æ–≤—ã–π endpoint = —Å–æ–∑–¥–∞–π –Ω–æ–≤—ã–π —Ä–æ—É—Ç–µ—Ä –∏–ª–∏ –¥–æ–±–∞–≤—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
- ‚úÖ –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å
- ‚úÖ –ü–æ–Ω—è—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

---

## –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞: HTTP –∑–∞–ø—Ä–æ—Å

### ‚ùå –î–û
```python
# –í admin_app.py (—Å—Ç—Ä–æ–∫–∏ 51-90)
def _http_json(method: str, url: str, body: Dict[str, Any] | None = None, headers: Dict[str, str] | None = None, timeout: float = 15.0) -> Any:
    base = os.getenv("CM_BASE_URL", "http://127.0.0.1:10000")
    from urllib.parse import urlparse as _parse
    b = _parse(base)
    scheme = (b.scheme or "http").lower()
    host = b.hostname or "127.0.0.1"
    port = b.port or (443 if scheme == "https" else 80)
    # ... –µ—â–µ 30 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ ...

# –ò –¥–∞–ª–µ–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 50+ —Ä–∞–∑ –≤ —Ç–æ–º –∂–µ —Ñ–∞–π–ª–µ
data = await asyncio.to_thread(_http_json, "GET", "/api/clients")
```

### ‚úÖ –ü–û–°–õ–ï
```python
# –í utils/http_client.py - –æ–¥–∏–Ω —Ä–∞–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
# –í –∫–æ–¥–µ - –ø—Ä–æ—Å—Ç–æ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—à—å –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å
from utils.http_client import _http_json

data = await asyncio.to_thread(_http_json, "GET", "/api/clients")
```

**–≠–∫–æ–Ω–æ–º–∏—è:** –í–º–µ—Å—Ç–æ 50+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞, 1 —Å—Ç—Ä–æ–∫–∞ –∏–º–ø–æ—Ä—Ç–∞!

---

## –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞: JWT –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

### ‚ùå –î–û
```python
# –î—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ 3+ –º–µ—Å—Ç–∞—Ö –≤ admin_app.py!
admin_jwt_secret = os.getenv('ADMIN_JWT_SECRET', '')
if admin_jwt_secret:
    alg = os.getenv('ADMIN_JWT_ALG', 'HS256').upper()
    try:
      import jwt as _pyjwt
    except Exception:
      _pyjwt = None
    
    if alg == 'RS256' and _pyjwt:
      priv = os.getenv('ADMIN_JWT_PRIVATE_KEY')
      if not priv:
        priv_file = os.getenv('ADMIN_JWT_PRIVATE_KEY_FILE')
        # ... –µ—â–µ 40 —Å—Ç—Ä–æ–∫ ...
```

### ‚úÖ –ü–û–°–õ–ï
```python
from utils.auth import generate_jwt_token

token = generate_jwt_token(subject='install:agent-123')
# –í—Å–µ! –û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞!
```

**–≠–∫–æ–Ω–æ–º–∏—è:** 50+ —Å—Ç—Ä–æ–∫ ‚Üí 1 —Å—Ç—Ä–æ–∫–∞, –Ω–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è!

---

## –ü—Ä–∏–º–µ—Ä: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π endpoint

### ‚ùå –î–û
1. –û—Ç–∫—Ä—ã—Ç—å admin_app.py (1425 —Å—Ç—Ä–æ–∫)
2. Scroll down –¥–æ create_admin_app()
3. –ù–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–π endpoint
4. –í—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥ (–Ω–∞–¥–µ—è—Å—å —á—Ç–æ –Ω–µ —Å–ª–æ–º–∞–µ—à—å –æ—Ç—Å—Ç—É–ø—ã)
5. –ò—Å–∫–∞—Ç—å –≥–¥–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –Ω—É–∂–Ω–∞—è —É—Ç–∏–ª–∏—Ç–∞
6. –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å/–≤—Å—Ç–∞–≤–∏—Ç—å JWT –∫–æ–¥ –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

### ‚úÖ –ü–û–°–õ–ï
1. –°–æ–∑–¥–∞—Ç—å `routes/my_feature.py` (–∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–æ—É—Ç–µ—Ä)
2. –ù–∞–ø–∏—Å–∞—Ç—å —á–∏—Å—Ç—ã–π –∫–æ–¥:
```python
from fastapi import APIRouter
from utils.http_client import _http_json
from utils.auth import get_admin_headers

router = APIRouter(prefix="/my-feature")

@router.get("/data")
async def get_data():
    data = await asyncio.to_thread(
        _http_json, 
        "GET", 
        "/api/something",
        headers=get_admin_headers()
    )
    return data
```
3. –ü–æ–¥–∫–ª—é—á–∏—Ç—å –≤ app.py:
```python
from .routes import my_feature
app.include_router(my_feature.router, prefix="/api")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ß–∏—Å—Ç—ã–π –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥, –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —É—Ç–∏–ª–∏—Ç—ã!

---

## –ú–µ—Ç—Ä–∏–∫–∏

### –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤
| –§–∞–π–ª | –î–æ | –ü–æ—Å–ª–µ |
|------|-----|-------|
| admin_app.py | 1425 —Å—Ç—Ä–æ–∫ | ~200 —Å—Ç—Ä–æ–∫ (—Ç–æ–ª—å–∫–æ app factory) |
| utils/* | 0 | ~300 —Å—Ç—Ä–æ–∫ (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ) |
| routes/* | 0 | ~400 —Å—Ç—Ä–æ–∫ (–ø–æ –¥–æ–º–µ–Ω–∞–º) |
| **Total** | **1425** | **~900** (—Å –ª—É—á—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–µ–π!) |

### –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
| –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å | –î–æ | –ü–æ—Å–ª–µ |
|------------------|-----|-------|
| HTTP –∑–∞–ø—Ä–æ—Å—ã | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–æ 3 —Ä–∞–∑–∞ | 1 –º–æ–¥—É–ª—å |
| JWT –≥–µ–Ω–µ—Ä–∞—Ü–∏—è | –î—É–±–ª–∏—Ä—É–µ—Ç—Å—è 3+ —Ä–∞–∑ | 1 —Ñ—É–Ω–∫—Ü–∏—è |
| Admin headers | –ö–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤–µ–∑–¥–µ | 1 —Ñ—É–Ω–∫—Ü–∏—è |

### –ü–æ–Ω–∏–º–∞–Ω–∏–µ –∫–æ–¥–∞
| –ó–∞–¥–∞—á–∞ | –î–æ | –ü–æ—Å–ª–µ |
|--------|-----|-------|
| –ù–∞–π—Ç–∏ client endpoints | –ò—Å–∫–∞—Ç—å –≤ 1425 —Å—Ç—Ä–æ–∫–∞—Ö | –û—Ç–∫—Ä—ã—Ç—å routes/clients.py |
| –ü–æ–Ω—è—Ç—å JWT | –ß–∏—Ç–∞—Ç—å 3 —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ | –û—Ç–∫—Ä—ã—Ç—å utils/auth.py |
| –î–æ–±–∞–≤–∏—Ç—å endpoint | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–≥—Ä–æ–º–Ω—ã–π —Ñ–∞–π–ª | –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–æ—É—Ç–µ—Ä |

---

## –í—ã–≤–æ–¥—ã

### –ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–¥–∞:
- üî¥ **–ú–æ–Ω–æ–ª–∏—Ç**: 1425 —Å—Ç—Ä–æ–∫ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ
- üî¥ **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: JWT –∏ HTTP –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è
- üî¥ **–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –¢—è–∂–µ–ª–æ –Ω–∞–π—Ç–∏ –∏ –ø–æ–Ω—è—Ç—å –∫–æ–¥
- üî¥ **Maintenance**: –ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω–æ

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
- üü¢ **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å**: –ö–æ–¥ —Ä–∞–∑–±–∏—Ç –ø–æ –¥–æ–º–µ–Ω–∞–º
- üü¢ **DRY**: –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è, –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —É—Ç–∏–ª–∏—Ç—ã
- üü¢ **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –∏ –ø–æ–Ω—è—Ç—å
- üü¢ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤–æ–µ

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:
üëâ **–ù–∞—á–Ω–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã –°–ï–ì–û–î–ù–Ø**
üëâ **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –º–∏–≥—Ä–∏—Ä—É–π—Ç–µ endpoints –≤ routes/**
üëâ **–£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π admin_app.py –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—Ç–µ**

**–í—Ä–µ–º—è –Ω–∞ –ø–æ–ª–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é: 2-4 —á–∞—Å–∞**
**–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ –±—É–¥—É—â–µ–º: –ë–µ—Å—Ü–µ–Ω–Ω–æ!** üéâ
